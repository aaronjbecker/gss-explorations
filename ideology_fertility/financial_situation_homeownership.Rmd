---
title: "Financial Situation Change by Homeownership Status Over Time"
author: "Aaron J Becker"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Load packages

```{r packages}
library(gssr)
library(survey)
library(dplyr)
library(ggplot2)
library(tidyr)
```

## Load GSS data (run once)

```{r load-data, cache=TRUE}
# Load the GSS cumulative data file
data(gss_all)
```

## Parameters

```{r parameters}
# Design variables are available from 1975 onwards
min_year <- 1975

# Pooling window: how many surveys to pool together (centered)
# e.g., 5 = current survey plus two before and two after
pool_surveys <- 5
```

## Prepare and filter data

```{r prepare-data}
# Select relevant variables, filter, and create labels
gss_subset <- gss_all |>
  select(year, dwelown, finalter, vpsu, vstrat, wtssps) |>
  filter(
    !is.na(dwelown),
    dwelown <= 2,       # valid homeownership responses (1=own/buying, 2=renting)
    !is.na(finalter),
    finalter <= 3,      # valid finalter responses (1=better, 2=worse, 3=stayed same)
    !is.na(wtssps),
    year >= min_year
  ) |>
  mutate(
    homeownership = case_when(
      dwelown == 1 ~ "Own/Buying",
      dwelown == 2 ~ "Renting",
      TRUE ~ NA_character_
    ),
    finalter_label = case_when(
      finalter == 1 ~ "Better",
      finalter == 2 ~ "Worse",
      finalter == 3 ~ "Stayed Same",
      TRUE ~ NA_character_
    ),
    vpsu = as.numeric(vpsu),
    vstrat = as.numeric(vstrat),
    wtssps = as.numeric(wtssps),
    # Create year-specific strata to avoid collisions when pooling
    stratvar = interaction(year, vstrat, drop = TRUE)
  ) |>
  filter(!is.na(homeownership), !is.na(finalter_label))

gss_subset$homeownership <- factor(
  gss_subset$homeownership,
  levels = c("Own/Buying", "Renting")
)

gss_subset$finalter_label <- factor(
  gss_subset$finalter_label,
  levels = c("Better", "Stayed Same", "Worse")
)

# Verify data availability
cat("Total observations:", nrow(gss_subset), "\n")
cat("Year range:", min(gss_subset$year), "to", max(gss_subset$year), "\n")
cat("\nObservations by homeownership status:\n")
table(gss_subset$homeownership) |> print()
cat("\nObservations by financial situation:\n")
table(gss_subset$finalter_label) |> print()
```

## Create survey design object

Survey design handling follows the approach used in the regional analysis:
- Build year-specific strata (`stratvar = interaction(year, vstrat)`) to keep strata unique when pooling across years.
- Use `survey.lonely.psu = "adjust"` and `na.action = "na.pass"` to accommodate single-PSU strata created by pooling.

```{r survey-design}
options(survey.lonely.psu = "adjust")
options(na.action = "na.pass")

gss_design <- svydesign(
  ids = ~vpsu,
  strata = ~stratvar,
  weights = ~wtssps,
  data = gss_subset,
  nest = TRUE
)
```

## Compute proportions by homeownership with pooled surveys

```{r compute-pooled}
# Unique survey years and pooling radius
survey_years <- sort(unique(gss_subset$year))
pool_radius <- floor(pool_surveys / 2)

cat("Survey years available:", paste(survey_years, collapse = ", "), "\n")
cat("Total number of surveys:", length(survey_years), "\n\n")

# Containers
pooled_results <- list()

homeownership_groups <- levels(gss_subset$homeownership)

for (i in seq_along(survey_years)) {
  target_year <- survey_years[i]

  # Determine which survey indices to pool
  start_idx <- max(1, i - pool_radius)
  end_idx <- min(length(survey_years), i + pool_radius)
  years_to_pool <- survey_years[start_idx:end_idx]

  pooled_data_indices <- which(gss_subset$year %in% years_to_pool)

  if (length(pooled_data_indices) > 0) {
    pooled_design <- gss_design[pooled_data_indices, ]

    for (homeown in homeownership_groups) {
      homeown_indices <- which(gss_subset$homeownership[pooled_data_indices] == homeown)

      if (length(homeown_indices) > 0) {
        homeown_design <- pooled_design[homeown_indices, ]

        # Distribution across all finalter categories
        finalter_props <- svymean(
          ~finalter_label,
          design = homeown_design,
          na.rm = TRUE
        )

        prop_values <- as.numeric(finalter_props)
        prop_names <- gsub("finalter_label", "", names(finalter_props))
        se_values <- as.numeric(SE(finalter_props))

        props_df <- data.frame(
          year = rep(target_year, length(prop_names)),
          homeownership = rep(homeown, length(prop_names)),
          financial_status = prop_names,
          proportion = prop_values,
          se = se_values,
          ci_lower = prop_values - 1.96 * se_values,
          ci_upper = prop_values + 1.96 * se_values,
          n_surveys = rep(length(years_to_pool), length(prop_names)),
          stringsAsFactors = FALSE
        )

        pooled_results[[length(pooled_results) + 1]] <- props_df
      }
    }
  }
}

# Combine results
results_df <- do.call(rbind, pooled_results)

results_df$financial_status <- factor(
  results_df$financial_status,
  levels = c("Better", "Stayed Same", "Worse")
)

results_df$homeownership <- factor(
  results_df$homeownership,
  levels = c("Own/Buying", "Renting")
)

cat("Pooled estimates complete\n")
head(results_df, 15)
```

## Plot: Financial situation change by homeownership over time

```{r financial-plot, fig.width=10, fig.height=12.5}
homeown_colors <- c(
  "Own/Buying" = "#2ca02c",
  "Renting" = "#ff7f0e"
)

# Create more descriptive labels for facets
results_df$outcome_label <- case_when(
  results_df$financial_status == "Better" ~ "Financial Situation Improved",
  results_df$financial_status == "Stayed Same" ~ "Financial Situation Stayed the Same",
  results_df$financial_status == "Worse" ~ "Financial Situation Worsened"
)

results_df$outcome_label <- factor(
  results_df$outcome_label,
  levels = c("Financial Situation Improved",
             "Financial Situation Stayed the Same",
             "Financial Situation Worsened")
)

ggplot(results_df, aes(x = year, y = proportion, color = homeownership, fill = homeownership)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.18, color = NA) +
  geom_line(linewidth = 1) +
  facet_wrap(~outcome_label, ncol = 1, scales = "free_y") +
  scale_color_manual(values = homeown_colors, name = "Homeownership Status") +
  scale_fill_manual(values = homeown_colors, name = "Homeownership Status") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Perceived Financial Situation Change by Homeownership Status, USA, 1975-2024",
    subtitle = paste0(
      "Question: 'During the last few years, has your financial situation been getting better, worse,\n\tor has it stayed the same?'\n",
      "General Social Survey (pooling ", pool_surveys, " surveys, centered).\n",
      "Lines show survey-weighted proportions; ribbons are 95% confidence intervals."
    ),
    x = "Year",
    y = "Proportion of respondents",
    caption = c("Data source: NORC General Social Survey (GSS)", "aaronjbecker.com")
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size=14),
    strip.text = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 14),
    plot.caption = element_text(size = c(9, 14), hjust = c(0, 1), face=c("italic", "plain"))
  )
```

## Summary statistics by homeownership (all years pooled)

```{r summary-stats}
# Compute overall proportions by homeownership across all years
overall_design <- gss_design

summary_by_homeown <- list()

for (homeown in homeownership_groups) {
  homeown_indices <- which(gss_subset$homeownership == homeown)

  if (length(homeown_indices) > 0) {
    homeown_design <- overall_design[homeown_indices, ]

    finalter_props <- svymean(~finalter_label, design = homeown_design, na.rm = TRUE)

    prop_values <- as.numeric(finalter_props)
    prop_names <- gsub("finalter_label", "", names(finalter_props))
    se_values <- as.numeric(SE(finalter_props))

    props_df <- data.frame(
      homeownership = homeown,
      financial_status = prop_names,
      proportion = prop_values,
      se = se_values,
      stringsAsFactors = FALSE
    )

    summary_by_homeown[[length(summary_by_homeown) + 1]] <- props_df
  }
}

summary_df <- do.call(rbind, summary_by_homeown)

cat("\nOverall proportions by homeownership (all years, survey-weighted):\n")
print(summary_df, digits = 3)
```

## Notes

- Uses the same rolling pooled estimation and survey design handling as the regional ideology analysis (`stratvar` interaction, `nest = TRUE`, `survey.lonely.psu = "adjust"`).
- Homeownership grouping: Own/Buying (dwelown=1), Renting (dwelown=2).
- The `finalter` variable asks about change in financial situation over "the last few years."
- The faceted line plot shows all three categories (improved, stayed same, worsened) with trends over time and 95% confidence intervals for each homeownership status.
- This analysis examines financial situation perceptions by homeownership status without controlling for political ideology or party identification.
