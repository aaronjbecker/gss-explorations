---
title: "Ideological Composition of Party Identification Groups Over Time"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Load packages

```{r packages}
library(gssr)
library(survey)
library(dplyr)
library(ggplot2)
library(tidyr)
```

## Load GSS data (run once)

```{r load-data, cache=TRUE}
# Load the GSS cumulative data file
data(gss_all)
```

## Parameters

```{r parameters}
# Set minimum year (design variables available from 1975 onwards)
min_year <- 1975

# Pooling window: how many surveys to pool together (centered)
pool_surveys <- 5
```

## Prepare and filter data

```{r prepare-data}
# Select relevant variables and create categories
# No age filter for this analysis
gss_subset <- gss_all |>
  select(year, partyid, polviews, vpsu, vstrat, wtssps) |>
  filter(
    !is.na(partyid), 
    !is.na(polviews),
    !is.na(wtssps),
    year >= min_year,
    partyid <= 6,  # Exclude "Other party" (value 7)
    polviews <= 7  # Valid political views
  ) |>
  mutate(
    party_grouped = case_when(
      partyid %in% 0:2 ~ "Democrat",
      partyid == 3 ~ "Independent",
      partyid %in% 4:6 ~ "Republican",
      TRUE ~ NA_character_
    ),
    ideology_label = case_when(
      polviews == 1 ~ "Extremely Liberal",
      polviews == 2 ~ "Liberal",
      polviews == 3 ~ "Slightly Liberal",
      polviews == 4 ~ "Moderate",
      polviews == 5 ~ "Slightly Conservative",
      polviews == 6 ~ "Conservative",
      polviews == 7 ~ "Extremely Conservative",
      TRUE ~ NA_character_
    ),
    # Follow gssr guidance: ensure survey variables are numeric and create
    # year-specific strata to avoid collisions when pooling across years
    vpsu = as.numeric(vpsu),
    vstrat = as.numeric(vstrat),
    wtssps = as.numeric(wtssps),
    stratvar = interaction(year, vstrat, drop = TRUE),
    all_respondents = "All"
  ) |>
  filter(!is.na(party_grouped), !is.na(ideology_label))

# Verify data availability
cat("Total observations:", nrow(gss_subset), "\n")
cat("Year range:", min(gss_subset$year), "to", max(gss_subset$year), "\n")
cat("\nObservations by party identification:\n")
table(gss_subset$party_grouped) |> print()
cat("\nObservations by ideology:\n")
table(gss_subset$ideology_label) |> print()
```

## Create survey design object

Survey data need their complex design accounted for: the GSS is a stratified, clustered sample with weights to recover population estimates.[^1] Ignoring that structure inflates precision and can bias point estimates, especially when pooling many years. We therefore build a design object before computing any proportions.

[^1]: Stratified sampling: the survey first divides the population into buckets (strata) like regions or demographic groups, then samples within each so all buckets are represented. Clustered sampling: instead of sampling individuals all over the map, the survey samples groups (PSUs) such as geographic areas and interviews multiple people inside each, which is cheaper but creates correlation within clusters.

Before building the survey design we follow the gssr guidance for pooling across years:
- GSS reuses `vstrat` codes across years, so we build a year-specific stratum ID `stratvar = interaction(year, vstrat, drop = TRUE)` to keep strata unique when multiple years are pooled.
- We keep PSUs as provided (`vpsu`) and weights (`wtssps`, recommended 1972â€“2024 post-stratification weight) and set `nest = TRUE` to respect strata nesting.
- `survey.lonely.psu = "adjust"` handles single-PSU strata produced by the interaction, and `na.action = "na.pass"` avoids dropping cases before the design is constructed.

```{r survey-design}
# Set option for handling strata with single PSUs
options(survey.lonely.psu = "adjust")
options(na.action = "na.pass")

# Use full complex survey design
gss_design <- svydesign(
  ids = ~vpsu,
  strata = ~stratvar,
  weights = ~wtssps,
  data = gss_subset,
  nest = TRUE
)
```

## Compute ideology shares within each party over time

```{r compute-shares}
# Get all unique survey years
survey_years <- sort(unique(gss_subset$year))
pool_radius <- floor(pool_surveys / 2)

cat("Survey years available:", paste(survey_years, collapse = ", "), "\n")
cat("Total number of surveys:", length(survey_years), "\n\n")

# Initialize results list
pooled_results <- list()

# For each survey year, pool surrounding surveys
for (i in seq_along(survey_years)) {
  target_year <- survey_years[i]
  
  # Determine which survey indices to pool
  start_idx <- max(1, i - pool_radius)
  end_idx <- min(length(survey_years), i + pool_radius)
  years_to_pool <- survey_years[start_idx:end_idx]
  
  # Get data indices for these years
  pooled_data_indices <- which(gss_subset$year %in% years_to_pool)
  
  if (length(pooled_data_indices) > 0) {
    # Create subset design for pooled surveys
    pooled_design <- gss_design[pooled_data_indices, ]
    
    # For each party group, compute the distribution across ideologies
    for (party in c("Democrat", "Independent", "Republican")) {
      # Subset to just this party
      party_indices <- which(gss_subset$year[pooled_data_indices] %in% years_to_pool & 
                             gss_subset$party_grouped[pooled_data_indices] == party)
      
      if (length(party_indices) > 0) {
        party_design <- pooled_design[party_indices, ]
        
        # Compute proportions of each ideology within this party
        ideology_props <- svymean(
          ~ideology_label,
          design = party_design,
          na.rm = TRUE
        )
        
        # Extract just the proportions (not standard errors)
        prop_values <- as.numeric(ideology_props)
        prop_names <- gsub("ideology_label", "", names(ideology_props))
        
        # Create data frame - replicate scalar values to match number of ideologies
        props_df <- data.frame(
          year = rep(target_year, length(prop_names)),
          party = rep(party, length(prop_names)),
          ideology = prop_names,
          proportion = prop_values,
          n_surveys = rep(length(years_to_pool), length(prop_names)),
          stringsAsFactors = FALSE
        )

        pooled_results[[length(pooled_results) + 1]] <- props_df
      }
    }
  }
}

# Combine all results
results_df <- do.call(rbind, pooled_results)

# Order ideology levels
results_df$ideology <- factor(
  results_df$ideology,
  levels = c("Extremely Liberal", "Liberal", "Slightly Liberal", "Moderate",
             "Slightly Conservative", "Conservative", "Extremely Conservative")
)

cat("Composition analysis complete\n")
head(results_df, 20)
```

## Stacked area plots

```{r stacked-plots, fig.width=10, fig.height=16}
# Create color palette for ideologies (blue to red)
ideology_colors <- c(
  "Extremely Liberal" = "#053061",
  "Liberal" = "#2166AC",
  "Slightly Liberal" = "#4393C3",
  "Moderate" = "#762A83",
  "Slightly Conservative" = "#D6604D",
  "Conservative" = "#B2182B",
  "Extremely Conservative" = "#67001F"
)

# Create stacked area plot for each party
ggplot(results_df, aes(x = year, y = proportion, fill = ideology)) +
  geom_area(position = "stack", alpha = 0.8) +
  facet_wrap(~party, ncol = 1) +
  scale_fill_manual(
    values = ideology_colors,
    name = "Political Ideology"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Ideological Composition of Party Identification Groups Over Time",
    subtitle = paste0(
      "General Social Survey (pooling ", pool_surveys, " surveys)\n",
      "Stacked areas show proportion of each ideology within party group"
    ),
    x = "Year",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, face = "bold"),
    strip.text = element_text(size = 12, face = "bold"),
    axis.title = element_text(size = 11),
    panel.spacing = unit(1.5, "lines")
  )
```

## Summary: Recent composition

```{r recent-composition}
# Show composition in most recent period
recent_year <- max(results_df$year)

recent_composition <- results_df |>
  filter(year == recent_year) |>
  select(party, ideology, proportion) |>
  arrange(party, ideology)

# Create a wide format table
recent_wide <- recent_composition |>
  pivot_wider(names_from = ideology, values_from = proportion, values_fill = 0)

knitr::kable(
  recent_wide,
  digits = 3,
  caption = paste0("Ideological Composition by Party Group (", recent_year, ")")
)
```

## Trend analysis: Polarization metrics

```{r polarization-metrics}
# Calculate mean ideology position over time for each party
# (treating ideology as ordinal: 1=Extremely Liberal to 7=Extremely Conservative)
ideology_numeric <- results_df |>
  mutate(
    ideology_num = case_when(
      ideology == "Extremely Liberal" ~ 1,
      ideology == "Liberal" ~ 2,
      ideology == "Slightly Liberal" ~ 3,
      ideology == "Moderate" ~ 4,
      ideology == "Slightly Conservative" ~ 5,
      ideology == "Conservative" ~ 6,
      ideology == "Extremely Conservative" ~ 7
    )
  )

mean_ideology <- ideology_numeric |>
  group_by(party, year) |>
  summarise(
    mean_position = sum(ideology_num * proportion),
    .groups = "drop"
  )

# Plot mean ideological position over time
ggplot(mean_ideology, aes(x = year, y = mean_position, color = party)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_color_manual(
    values = c("Democrat" = "#2166AC", "Independent" = "#762A83", "Republican" = "#B2182B"),
    name = "Party"
  ) +
  scale_y_continuous(
    breaks = 1:7,
    labels = c("Extremely\nLiberal", "Liberal", "Slightly\nLiberal", "Moderate", 
               "Slightly\nConservative", "Conservative", "Extremely\nConservative")
  ) +
  labs(
    title = "Mean Ideological Position by Party Over Time",
    subtitle = paste0("General Social Survey (pooling ", pool_surveys, " surveys)"),
    x = "Year",
    y = "Mean Ideology Position"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(size = 14, face = "bold"),
    axis.text.y = element_text(size = 8)
  )
```

## Overall ideology distribution over time

```{r overall-ideology, fig.width=12, fig.height=6}
# Compute overall ideology distribution (all respondents)
# Use svyby to get proportions with standard errors
overall_ideology_results <- list()

for (i in seq_along(survey_years)) {
  target_year <- survey_years[i]

  # Determine which survey indices to pool
  start_idx <- max(1, i - pool_radius)
  end_idx <- min(length(survey_years), i + pool_radius)
  years_to_pool <- survey_years[start_idx:end_idx]

  # Get data indices for these years
  pooled_data_indices <- which(gss_subset$year %in% years_to_pool)

  if (length(pooled_data_indices) > 0) {
    # Create subset design for pooled surveys
    pooled_design <- gss_design[pooled_data_indices, ]

    # Use svyby to get proportions with standard errors
    ideology_props_by <- svyby(
      formula = ~ideology_label,
      by = ~all_respondents,
      design = pooled_design,
      FUN = svymean,
      na.rm = TRUE
    )

    # Extract proportions and standard errors
    prop_cols <- grep("^ideology_label[^s]", names(ideology_props_by), value = TRUE)
    se_cols <- grep("^se\\.ideology_label", names(ideology_props_by), value = TRUE)

    prop_names <- gsub("ideology_label", "", prop_cols)
    prop_values <- as.numeric(ideology_props_by[1, prop_cols])
    se_values <- as.numeric(ideology_props_by[1, se_cols])

    # Create data frame with confidence intervals
    props_df <- data.frame(
      year = rep(target_year, length(prop_names)),
      ideology = prop_names,
      proportion = prop_values,
      se = se_values,
      ci_lower = prop_values - 1.96 * se_values,
      ci_upper = prop_values + 1.96 * se_values,
      n_surveys = rep(length(years_to_pool), length(prop_names)),
      stringsAsFactors = FALSE
    )

    overall_ideology_results[[length(overall_ideology_results) + 1]] <- props_df
  }
}

# Combine results
overall_ideology_df <- do.call(rbind, overall_ideology_results)

# Order ideology levels
overall_ideology_df$ideology <- factor(
  overall_ideology_df$ideology,
  levels = c("Extremely Liberal", "Liberal", "Slightly Liberal", "Moderate",
             "Slightly Conservative", "Conservative", "Extremely Conservative")
)

# Create stacked area plot
ggplot(overall_ideology_df, aes(x = year, y = proportion, fill = ideology)) +
  geom_area(position = "stack", alpha = 0.8) +
  scale_fill_manual(
    values = ideology_colors,
    name = "Political Ideology"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Ideological Distribution of All GSS Respondents Over Time",
    subtitle = paste0(
      "General Social Survey (pooling ", pool_surveys, " surveys)\n",
      "Stacked areas show proportion of each ideology level"
    ),
    x = "Year",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

## Ideology trends with confidence intervals

```{r ideology-ci, fig.width=12, fig.height=8}
# Create line plot with confidence intervals for ideology
ggplot(overall_ideology_df, aes(x = year, y = proportion, color = ideology, fill = ideology)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1) +
  geom_point(size = 1.5) +
  scale_color_manual(
    values = ideology_colors,
    name = "Political Ideology"
  ) +
  scale_fill_manual(
    values = ideology_colors,
    name = "Political Ideology"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Ideological Trends Over Time with 95% Confidence Intervals",
    subtitle = paste0(
      "General Social Survey (pooling ", pool_surveys, " surveys)\n",
      "Shaded areas represent 95% confidence intervals"
    ),
    x = "Year",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

## Overall party affiliation distribution over time (ungrouped)

```{r overall-party-ungrouped, fig.width=12, fig.height=6}
# First, create ungrouped party labels
gss_subset_party <- gss_all |>
  select(year, partyid, polviews, vpsu, vstrat, wtssps) |>
  filter(
    !is.na(partyid),
    !is.na(polviews),
    !is.na(wtssps),
    year >= min_year,
    partyid <= 6,  # Exclude "Other party" (value 7)
    polviews <= 7  # Valid political views
  ) |>
  mutate(
    party_ungrouped = case_when(
      partyid == 0 ~ "Strong Democrat",
      partyid == 1 ~ "Not Strong Democrat",
      partyid == 2 ~ "Independent, Near Democrat",
      partyid == 3 ~ "Independent",
      partyid == 4 ~ "Independent, Near Republican",
      partyid == 5 ~ "Not Strong Republican",
      partyid == 6 ~ "Strong Republican",
      TRUE ~ NA_character_
    ),
    vpsu = as.numeric(vpsu),
    vstrat = as.numeric(vstrat),
    wtssps = as.numeric(wtssps),
    stratvar = interaction(year, vstrat, drop = TRUE)
  ) |>
  filter(!is.na(party_ungrouped))

# Create survey design for ungrouped party analysis
gss_design_party <- svydesign(
  ids = ~vpsu,
  strata = ~stratvar,
  weights = ~wtssps,
  data = gss_subset_party,
  nest = TRUE
)

# Compute overall party distribution (ungrouped)
overall_party_ungrouped_results <- list()

for (i in seq_along(survey_years)) {
  target_year <- survey_years[i]

  # Determine which survey indices to pool
  start_idx <- max(1, i - pool_radius)
  end_idx <- min(length(survey_years), i + pool_radius)
  years_to_pool <- survey_years[start_idx:end_idx]

  # Get data indices for these years
  pooled_data_indices <- which(gss_subset_party$year %in% years_to_pool)

  if (length(pooled_data_indices) > 0) {
    # Create subset design for pooled surveys
    pooled_design <- gss_design_party[pooled_data_indices, ]

    # Compute proportions of each party affiliation
    party_props <- svymean(
      ~party_ungrouped,
      design = pooled_design,
      na.rm = TRUE
    )

    # Extract proportions
    prop_values <- as.numeric(party_props)
    prop_names <- gsub("party_ungrouped", "", names(party_props))

    # Create data frame
    props_df <- data.frame(
      year = rep(target_year, length(prop_names)),
      party = prop_names,
      proportion = prop_values,
      n_surveys = rep(length(years_to_pool), length(prop_names)),
      stringsAsFactors = FALSE
    )

    overall_party_ungrouped_results[[length(overall_party_ungrouped_results) + 1]] <- props_df
  }
}

# Combine results
overall_party_ungrouped_df <- do.call(rbind, overall_party_ungrouped_results)

# Order party levels
overall_party_ungrouped_df$party <- factor(
  overall_party_ungrouped_df$party,
  levels = c("Strong Democrat", "Not Strong Democrat", "Independent, Near Democrat",
             "Independent",
             "Independent, Near Republican", "Not Strong Republican", "Strong Republican")
)

# Create color palette for parties (blue to red)
party_ungrouped_colors <- c(
  "Strong Democrat" = "#053061",
  "Not Strong Democrat" = "#2166AC",
  "Independent, Near Democrat" = "#4393C3",
  "Independent" = "#762A83",
  "Independent, Near Republican" = "#D6604D",
  "Not Strong Republican" = "#B2182B",
  "Strong Republican" = "#67001F"
)

# Create stacked area plot
ggplot(overall_party_ungrouped_df, aes(x = year, y = proportion, fill = party)) +
  geom_area(position = "stack", alpha = 0.8) +
  scale_fill_manual(
    values = party_ungrouped_colors,
    name = "Party Identification"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Party Affiliation Distribution of All GSS Respondents Over Time (Ungrouped)",
    subtitle = paste0(
      "General Social Survey (pooling ", pool_surveys, " surveys)\\n",
      "Stacked areas show proportion of each party identification level"
    ),
    x = "Year",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

## Overall party affiliation distribution over time (grouped)

```{r overall-party-grouped, fig.width=12, fig.height=6}
# Compute overall party distribution (grouped: Democrat, Independent, Republican)
# Recreate survey design with the new variable
gss_design <- svydesign(
  ids = ~vpsu,
  strata = ~stratvar,
  weights = ~wtssps,
  data = gss_subset,
  nest = TRUE
)

overall_party_grouped_results <- list()

for (i in seq_along(survey_years)) {
  target_year <- survey_years[i]

  # Determine which survey indices to pool
  start_idx <- max(1, i - pool_radius)
  end_idx <- min(length(survey_years), i + pool_radius)
  years_to_pool <- survey_years[start_idx:end_idx]

  # Get data indices for these years
  pooled_data_indices <- which(gss_subset$year %in% years_to_pool)

  if (length(pooled_data_indices) > 0) {
    # Create subset design for pooled surveys
    pooled_design <- gss_design[pooled_data_indices, ]

    # Use svyby to get proportions with standard errors
    # We compute the proportion of each party group within "all respondents"
    party_props_by <- svyby(
      formula = ~party_grouped,
      by = ~all_respondents,
      design = pooled_design,
      FUN = svymean,
      na.rm = TRUE
    )

    # Extract proportions and standard errors
    # svyby returns columns: all_respondents, party_groupedDemocrat, se.party_groupedDemocrat, etc.
    prop_cols <- grep("^party_grouped[^s]", names(party_props_by), value = TRUE)
    se_cols <- grep("^se\\.party_grouped", names(party_props_by), value = TRUE)

    prop_names <- gsub("party_grouped", "", prop_cols)
    prop_values <- as.numeric(party_props_by[1, prop_cols])
    se_values <- as.numeric(party_props_by[1, se_cols])

    # Create data frame with confidence intervals
    props_df <- data.frame(
      year = rep(target_year, length(prop_names)),
      party = prop_names,
      proportion = prop_values,
      se = se_values,
      ci_lower = prop_values - 1.96 * se_values,
      ci_upper = prop_values + 1.96 * se_values,
      n_surveys = rep(length(years_to_pool), length(prop_names)),
      stringsAsFactors = FALSE
    )

    overall_party_grouped_results[[length(overall_party_grouped_results) + 1]] <- props_df
  }
}

# Combine results
overall_party_grouped_df <- do.call(rbind, overall_party_grouped_results)

# Order party levels
overall_party_grouped_df$party <- factor(
  overall_party_grouped_df$party,
  levels = c("Democrat", "Independent", "Republican")
)

# Create color palette for grouped parties
party_grouped_colors <- c(
  "Democrat" = "#2166AC",
  "Independent" = "#762A83",
  "Republican" = "#B2182B"
)

# Create stacked area plot
ggplot(overall_party_grouped_df, aes(x = year, y = proportion, fill = party)) +
  geom_area(position = "stack", alpha = 0.8) +
  scale_fill_manual(
    values = party_grouped_colors,
    name = "Party Identification"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Party Affiliation Distribution of All GSS Respondents Over Time (Grouped)",
    subtitle = paste0(
      "General Social Survey (pooling ", pool_surveys, " surveys)\\n",
      "Democrat (0-2), Independent (3), Republican (4-6)"
    ),
    x = "Year",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

## Party affiliation trends with confidence intervals

```{r party-grouped-ci, fig.width=12, fig.height=6}
# Create line plot with confidence intervals
ggplot(overall_party_grouped_df, aes(x = year, y = proportion, color = party, fill = party)) +
  geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper), alpha = 0.2, color = NA) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_color_manual(
    values = party_grouped_colors,
    name = "Party Identification"
  ) +
  scale_fill_manual(
    values = party_grouped_colors,
    name = "Party Identification"
  ) +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(
    title = "Party Affiliation Trends Over Time with 95% Confidence Intervals",
    subtitle = paste0(
      "General Social Survey (pooling ", pool_surveys, " surveys)\n",
      "Democrat (0-2), Independent (3), Republican (4-6)\n",
      "Shaded areas represent 95% confidence intervals"
    ),
    x = "Year",
    y = "Proportion"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    plot.title = element_text(size = 14, face = "bold"),
    axis.title = element_text(size = 11)
  )
```

## Notes

- This analysis examines the **ideological composition** within party identification groups
- **No age filter** is applied (includes all respondents)
- Party groups: Democrat (0-2), Independent (3), Republican (4-6)
- Ideology measured at 7 levels from Extremely Liberal to Extremely Conservative
- Uses **`r pool_surveys`-survey pooling** to smooth trends
- Stacked areas show the proportion of each ideology level within each party group
- Uses `wtssps` (recommended post-stratification weight for 1972-2024)
- Properly accounts for GSS complex survey design