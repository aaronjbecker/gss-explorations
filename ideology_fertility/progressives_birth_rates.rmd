---
title: "Average Number of Children by Political Views and Year"
author: "Your Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Load packages

```{r packages}
library(gssr)
library(survey)
library(dplyr)
library(ggplot2)
```

## Parameters

```{r parameters}
# Set minimum age filter
min_age <- 35

# Set minimum year (design variables available from 1975 onwards)
min_year <- 1975
```

## Load and prepare GSS data

```r{r load-data}
# Load the GSS cumulative data file
data(gss_all)
```

```{r load-data}
# Select relevant variables, filter, and create political view categories
gss_subset <- gss_all %>%
  select(year, childs, polviews, age, vpsu, vstrat, wtssall) %>%
  filter(
    !is.na(childs), 
    !is.na(polviews),
    !is.na(age),
    age >= min_age,
    year >= min_year  # Only include years with design variables
  ) %>%
  mutate(
    polviews_grouped = case_when(
      polviews %in% 1:3 ~ "Liberal",
      polviews == 4 ~ "Moderate",
      polviews %in% 5:7 ~ "Conservative",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(polviews_grouped))

# Verify design variables are complete
cat("Total observations:", nrow(gss_subset), "\n")
cat("Rows with complete design info:", sum(!is.na(gss_subset$vpsu) & !is.na(gss_subset$vstrat)), "\n")
cat("Year range:", min(gss_subset$year), "to", max(gss_subset$year), "\n")
```

## Create survey design object

```{r survey-design}
# Set option for handling strata with single PSUs
# "adjust" scales the variance appropriately for singleton strata
options(survey.lonely.psu = "adjust")

# Use full complex survey design with clustering and stratification
gss_design <- svydesign(
  ids = ~vpsu,
  strata = ~vstrat,
  weights = ~wtssall,
  data = gss_subset,
  nest = TRUE
)
```

## Compute weighted means

```{r compute-means}
# Calculate average number of children by political views and year
results <- svyby(
  formula = ~childs,
  by = ~polviews_grouped + year,
  design = gss_design,
  FUN = svymean,
  na.rm = TRUE
)

# Convert to data frame for easier viewing
results_df <- as.data.frame(results)
head(results_df, 20)
```

## Visualize trends

```{r visualize, fig.width=10, fig.height=6}
# Plot average number of children over time by political views
ggplot(results_df, aes(x = year, y = childs, color = polviews_grouped)) +
  geom_line(linewidth = 1) +
  geom_point() +
  scale_color_manual(
    values = c("Liberal" = "#2166AC", "Moderate" = "#762A83", "Conservative" = "#B2182B"),
    name = "Political Views"
  ) +
  labs(
    title = "Average Number of Children by Political Views Over Time",
    subtitle = paste0("General Social Survey (weighted estimates, age >= ", min_age, ", years >= ", min_year, ")"),
    x = "Year",
    y = "Average Number of Children"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")
```

## Summary statistics

```{r summary-stats}
# Overall averages by political view
overall_by_polviews <- svyby(
  formula = ~childs,
  by = ~polviews_grouped,
  design = gss_design,
  FUN = svymean,
  na.rm = TRUE
)

knitr::kable(
  overall_by_polviews,
  digits = 3,
  col.names = c("Political Views", "Mean Children", "Std. Error"),
  caption = paste0("Overall Average Number of Children by Political Views (age >= ", min_age, ", years >= ", min_year, ")")
)
```

## Summary table by year

```{r summary-table}
# Create a wider summary table showing recent years
results_wide <- results_df %>%
  filter(year >= 2000) %>%
  select(year, polviews_grouped, childs, se) %>%
  arrange(year, polviews_grouped)

knitr::kable(
  results_wide,
  digits = 3,
  col.names = c("Year", "Political Views", "Mean Children", "Std. Error"),
  caption = paste0("Average Number of Children by Political Views (2000 onwards, age >= ", min_age, ", years >= ", min_year, ")")
)
```

## Notes

- This analysis filters for respondents aged **`r min_age`** or older
- Analysis includes data from **`r min_year`** onwards (when design variables became available)
- Political views are grouped as: Liberal (1-3), Moderate (4), Conservative (5-7)
- Uses the `wtssall` weight variable for cross-sectional analysis
- Properly accounts for the GSS complex survey design using clustering (`vpsu`) and stratification (`vstrat`)
- The `childs` variable records the number of children respondents have had